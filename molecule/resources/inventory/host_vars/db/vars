---
# Variables for creating a postgresql server
# mirsg.postgresql
postgresql_version: "12"
postgresql_service_name: "postgresql-{{ postgresql_version }}"
postgresql_package_name: "postgresql{{ postgresql_version | replace('.', '') }}"
postgresql_bin_directory: "/usr/pgsql-{{ postgresql_version }}/bin"
postgresql_data_directory: "/var/lib/pgsql/{{ postgresql_version }}/data"

# mirsg.postgresql download and install
postgresql:
  owner: "postgresql"
  group: "postgresql"
  base_directory: "/var/lib/pgsql"
  bin_directory: "{{ postgresql_bin_directory }}"
  external_storage_directory: "/storage/pgsql"
  external_data_directory: "/storage/pgsql/{{ postgresql_version }}/data"  # symlink to data_directory
  disable_gpg_check: "{{ true if 'azure' in inventory_hostname else false }}"  # only disable when running on Azure
  rpm_gpg_key_pgdg: "https://www.postgresqlql.org/download/keys/RPM-GPG-KEY-PGDG"  # not needed for CentOS 7
  rpm: "https://download.postgresql.org/pub/repos/yum/reporpms/EL-{{ ansible_facts['distribution_major_version'] }}-x86_64/pgdg-redhat-repo-latest.noarch.rpm"
  yum_package: "{{ postgresql_package_name }}-server"
  yum_contrib_package: "{{ postgresql_package_name }}-contrib"  # required only on CentOS 7

# mirsg.postgresql service
postgresql_service:
  name: "{{ postgresql_service_name }}"
  filename: "/etc/systemd/system/{{ postgresql_service_name }}.service"
  setup_command: "{{ postgresql_bin_directory }}/{{ postgresql_service_name }}-setup"

# mirsg.postgresql setup
postgresql_configuration:
  configuration_directory: "{{ postgresql_data_directory }}"
  configuration_filename: "{{ postgresql_data_directory }}/postgresql.conf"
  hba_configuration_filename: "{{ postgresql_data_directory }}/pg_hba.conf"
  data_directory: "{{ postgresql_data_directory }}"
  log_directory: "/var/log/postgresql"
  host: "{{ db_vm.hostname }}"
  port: "{{ db_vm.port }}"
  name: "{{ db_vm.database_name }}"
  user: "{{ db_vm.database_user }}"
  password: "{{ db_vm.database_password }}"
  client_ip: "{{ web_vm.ip }}"  # required if using SSL
  client_certificate_filename: "/var/lib/pgsql/certs/root.crt"  # required if using SSL, where to copy the client certificate to on the server
  data_files_regex: "/var/lib/pgsql(/.*)?"  # required if SELinux is enabled, allow postgresql to modify these files

#Â mirsg.postgresql backup
postgresql_backup:
  backup_directory: "/var/lib/pgsql/backups"
  backup_script: "/var/lib/pgsql/run_db_backup.sh"  # script to run cron backup job

# mirsg.ssl_certificates
postgresql_ssl_certificate:
  owner: "{{ postgresql.owner }}"
  group: "{{ postgresql.group }}"
  certificate_directory: "/var/lib/pgsql/certs"
  privatekey_filename: "/var/lib/pgsql/certs/server.key"
  use_pk8: false
  csr_filename: "/var/lib/pgsql/certs/server.csr"
  csr_common_name: "{{ db_vm.hostname }}"
  certificate_filename: "/var/lib/pgsql/certs/server.crt"
  provider: "selfsigned"
  cache_filename: "{{ database_server_certificate_cache_filename }}" # required if using SSL, where to store the server certificate in cache
